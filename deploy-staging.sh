#!/bin/bash

set -e
GCLOUD_SERVICE_KEY_STG="ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic3BvdGlmeS1h
bmFseXplci0yNTAxMjIiLAogICJwcml2YXRlX2tleV9pZCI6ICI1NjJmY2NlMDI1MTY1M2EyM2Y3
ZjM3ZTk4OTkwZDY5YzgxYWNlMTc5IiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklW
QVRFIEtFWS0tLS0tXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdF
QUFvSUJBUUNOa09tNFpPcml4ZnBqXG5JZkd3ekhzS3IzOTZUMG15eUdkVDlkUWNLUUJhRUJsV1Ix
YmZFQURkMjhIeFV1bE9UWHV2UWJEYlA4VUw2V2pNXG5lY2FjMW1HTFVJVUkyN3dsU1Z6T08zbG92
bGRVOWFEZmRrYUg0UlZCSEJsT2tjdmdUL1VGWm0wQ2hFVXdqRjVoXG5pdGFuQTNKMVZRa2ZUL2x1
N2s2OG51eDFCdmc3ZkhoNnhyR1dFSlUrWXkwTzlaeldtS1hkQk1lMm16dUxSa3JrXG45UnhBU1g3
QkVyRHRXQkRqaTZISzhUYjVya1ZPQ1FDU3BzNFNTMVZSSC9LMGk3MGxGM0F6Z0F5d200TnUyTE5m
XG5oWUdsQ2JwVUIwL08wVk1IZDZWM3BHWW1UNDJWWStSazB2ak9YUTNyaE9scDRxd1pYcnVPN1hj
dk5aMkpySDQwXG5FeC94cXI4bkFnTUJBQUVDZ2dFQUFRSk1nQ1kvTDRjdjU1SmZxYmVnTGhQUkkw
ZTZ5Z3FGQkduZ29LUDBLOG5DXG5MNnZ3UzNlMUNFWXNNcGpTKzk0d0c4bkVMQWNTYlZ4b09FOUVy
d1d1OEg4bnVHR0s4d3l2RzcvOEt0YlpRa3hDXG5SeXZhVmRhWFdiQ01yZ2FVTWgyV0xNZjZaK3dX
QlBWREtQSTNldGNOOHhaVitEVjJuUFIrRUN2bFp2SWdlSm1vXG5TNkFuZWZzblJaMGI4S1B0aCtF
ejJMQW13RkIxS29IK1lEVTZIdDNINnZ4ODdhaGsxVTNYZC9jdUVjWTk5Vm1LXG5yelV2SlBCclJx
VDN3MXJrVnBVUy9oSU1kbzhjenZzL1RqZFRFU01OY0JTdHJ6YnRxRlVvWU5SWFJTQnBFRVU5XG40
SE1keFQrNnlUeElFb3RlZ2FaemZXMWlrdGhjazV1RGplUHorUjAyd1FLQmdRRERkWXpVc29TczlN
c3ZYQ0c4XG5RczZQTDhlKzZxRDRwSUdFN2hMbW1UaUJENHROc1lkNjJiTWJOcnVnUFNQbUcyWGtB
K2dHQktaZzFERHdYSWhmXG5jSTJZT0k3ZmxOMkpDSGJrazJidk1yYWhEbzg2STNQQldkcGxic056
ckVSeHJvdWFqQlBRSUZhbi9xQmdWZnZRXG5DWEFQN0svK0VSV2kveXQrWlV0d2llVXA1d0tCZ1FD
NWFncldneEkxWFBOZzN1alVQZVBIUklFL0lPd2gwVUI2XG40UU91T3VERkpzR1ZkMFJ6a1FNRCtN
Q083SmxzOVdzaXVUekFwRVdqZ1NFMUl2dytzdkU0Mm10Z0x2NFFmWHJPXG5mUktHSXVaU2VJb2lq
WDAxSWIyR2FiWDZ0eW5BUnJLNFpVWVVzYzU2QU9vdEdVQUFZMTdrUXF2MlIxSGxMdnVSXG5Kc3Q4
bmpPWXdRS0JnUUN1ek1lL3lFOGpKbUUzMzV0RDlETXFscjU2SFBjTXBvSTJVWHVSd3VGbmVuRklj
RVlMXG5OZm9aa2w5RnRLZ1FOOXh0aUpqT0dRWjZmZ211Uy9LaDk5U0psN3NlZE5HU3BZRStkaHlP
T3JwZFd0bjRVcEJKXG5FSVJpUmlhQm9rUXJycittM1RNeTVGamJNTHBZclV6Z0JqQ3o3U2FQZnRQ
c3kyc29SSXF0QUlWemJRS0JnQzQrXG56cmsyTStKdmJweW92SFhEZ2Y1L2phVUxOeG93TU43MUpJ
L2VTNVdnMXdQS25aNGRleDBRZkNhcHlKS3VtNndyXG5lNFdvODEyV3BZdTFVQ2pyUk5NalYwakVM
OFk1SmRvK3c5SUUvbUZ2Z3pTZkNhMm8zcmFad3pQblgxaC95YS9JXG5RclNDckxjdFp6c2NZeVEx
cE1OV0JjSUZnOTJmM0VzVjNBY1hCbE9CQW9HQkFKS0hVSUFsVUtqci9CQk1meWxiXG5qQmxTREtx
cFY2Z1ZaZStGTHFRN3lvSzZHQ1RZSmpySmRPWDltazBGT3VkQjUxdDZTc3ZnOVE1T0JTVFFLM0Jv
XG5nbDVXSm5RNnVJZlMxanZMclJUYnFEb0RsNDB2eGw5Y2Fmdkl5MFFQSEp6VXR1VllXVVd6L0Zo
UWlVbGdLdG8xXG5kUjFkQ0VtRG9FSTFNdmRQZHRQUHIzQ1hcbi0tLS0tRU5EIFBSSVZBVEUgS0VZ
LS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJ0cmF2aXNAc3BvdGlmeS1hbmFseXplci0yNTAx
MjIuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTA2NTU2MDI2MDYy
OTc1MDA1NzYwIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28v
b2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5j
b20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cu
Z29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwi
OiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS90cmF2
aXMlNDBzcG90aWZ5LWFuYWx5emVyLTI1MDEyMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
"
docker build -t $GCLOUD_HOSTNAME/$GCLOUD_PROJECT_ID/$DOCKER_IMAGE_NAME:$TRAVIS_COMMIT .
echo "after docker"
echo -e $GCLOUD_SERVICE_KEY_STG | base64 --decode -i > $HOME/gcloud-service-key.json
gcloud auth activate-service-account --key-file $HOME/gcloud-service-key.json
echo "after auth"
gcloud --quiet config set project ${GCLOUD_PROJECT_ID}
# gcloud --quiet config set container/cluster $CLUSTER_NAME_STG
gcloud --quiet config set compute/zone $GCLOUD_COMPUTE_ZONE
# gcloud --quiet container clusters get-credentials $CLUSTER_NAME_STG

gcloud docker push $GCLOUD_HOSTNAME/$GCLOUD_PROJECT_ID/$DOCKER_IMAGE_NAME
echo "after push"
